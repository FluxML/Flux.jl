<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>
Char RNN · Flux
    </title>
    <script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-36890222-9', 'auto');
ga('send', 'pageview');

    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/4.2.0/normalize.min.css" rel="stylesheet" type="text/css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.5.0/styles/default.min.css" rel="stylesheet" type="text/css"/>
    <link href="https://fonts.googleapis.com/css?family=Lato|Ubuntu+Mono" rel="stylesheet" type="text/css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="../assets/documenter.css" rel="stylesheet" type="text/css"/>
    <script>
documenterBaseURL=".."
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.2.0/require.min.js" data-main="../assets/documenter.js"></script>
    <script src="../../versions.js"></script>
    <link href="../../flux.css" rel="stylesheet" type="text/css"/>
  </head>
  <body>
    <nav class="toc">
      <h1>
Flux
      </h1>
      <form class="search" action="../search.html">
        <select id="version-selector" onChange="window.location.href=this.value">
          <option value="#" selected="selected" disabled="disabled">
Version
          </option>
        </select>
        <input id="search-query" name="q" type="text" placeholder="Search docs"/>
      </form>
      <ul>
        <li>
          <a class="toctext" href="../index.html">
Home
          </a>
        </li>
        <li>
          <span class="toctext">
Building Models
          </span>
          <ul>
            <li>
              <a class="toctext" href="../models/basics.html">
Model Building Basics
              </a>
            </li>
            <li>
              <a class="toctext" href="../models/templates.html">
Model Templates
              </a>
            </li>
            <li>
              <a class="toctext" href="../models/recurrent.html">
Recurrence
              </a>
            </li>
            <li>
              <a class="toctext" href="../models/debugging.html">
Debugging
              </a>
            </li>
          </ul>
        </li>
        <li>
          <span class="toctext">
Other APIs
          </span>
          <ul>
            <li>
              <a class="toctext" href="../apis/batching.html">
Batching
              </a>
            </li>
            <li>
              <a class="toctext" href="../apis/backends.html">
Backends
              </a>
            </li>
            <li>
              <a class="toctext" href="../apis/storage.html">
Storing Models
              </a>
            </li>
          </ul>
        </li>
        <li>
          <span class="toctext">
In Action
          </span>
          <ul>
            <li>
              <a class="toctext" href="logreg.html">
Simple MNIST
              </a>
            </li>
            <li class="current">
              <a class="toctext" href="char-rnn.html">
Char RNN
              </a>
              <ul class="internal"></ul>
            </li>
          </ul>
        </li>
        <li>
          <a class="toctext" href="../contributing.html">
Contributing &amp; Help
          </a>
        </li>
        <li>
          <a class="toctext" href="../internals.html">
Internals
          </a>
        </li>
      </ul>
    </nav>
    <article id="docs">
      <header>
        <nav>
          <ul>
            <li>
In Action
            </li>
            <li>
              <a href="char-rnn.html">
Char RNN
              </a>
            </li>
          </ul>
          <a class="edit-page" href="https://github.com/MikeInnes/Flux.jl/tree/7a85eff370b7c68d587b49699fa3f71e44993397/docs/src/examples/char-rnn.md">
            <span class="fa">

            </span>
 Edit on GitHub
          </a>
        </nav>
        <hr/>
      </header>
      <h1>
        <a class="nav-anchor" id="Char-RNN-1" href="#Char-RNN-1">
Char RNN
        </a>
      </h1>
      <p>
This walkthrough will take you through a model like that used in 
        <a href="http://karpathy.github.io/2015/05/21/rnn-effectiveness/">
Karpathy&#39;s 2015 blog post
        </a>
, which can learn to generate text in the style of Shakespeare (or whatever else you may use as input). 
<code>shakespeare_input.txt</code>
 is 
        <a href="http://cs.stanford.edu/people/karpathy/char-rnn/shakespeare_input.txt">
here
        </a>
.
      </p>
<pre><code class="language-julia">using Flux
import StatsBase: wsample</code></pre>
      <p>
Firstly, we define up front how many steps we want to unroll the RNN, and the number of data points to batch together. Then we create some functions to prepare our data, using Flux&#39;s built-in utilities.
      </p>
<pre><code class="language-julia">nunroll = 50
nbatch = 50

getseqs(chars, alphabet) =
  sequences((onehot(Float32, char, alphabet) for char in chars), nunroll)
getbatches(chars, alphabet) =
  batches((getseqs(part, alphabet) for part in chunk(chars, nbatch))...)</code></pre>
      <p>
Because we want the RNN to predict the next letter at each iteration, our target data is simply our input data offset by one. For example, if the input is &quot;The quick brown fox&quot;, the target will be &quot;he quick brown fox &quot;. Each letter is one-hot encoded and sequences are batched together to create the training data.
      </p>
<pre><code class="language-julia">input = readstring(&quot;shakespeare_input.txt&quot;);
alphabet = unique(input)
N = length(alphabet)

# An iterator of (input, output) pairs
train = zip(getbatches(input, alphabet), getbatches(input[2:end], alphabet))
# We will evaluate the loss on a particular batch to monitor the training.
eval = tobatch.(first(drop(train, 5)))</code></pre>
      <p>
Creating the model and training it is straightforward:
      </p>
<pre><code class="language-julia">model = Chain(
  Input(N),
  LSTM(N, 256),
  LSTM(256, 256),
  Affine(256, N),
  softmax)

m = tf(unroll(model, nunroll))

# Call this to see how the model is doing
evalcb = () -&gt; @show logloss(m(eval[1]), eval[2])

@time Flux.train!(m, train, η = 0.1, loss = logloss, cb = [evalcb])
</code></pre>
      <p>
Finally, we can sample the model. For sampling we remove the 
<code>softmax</code>
 from the end of the chain so that we can &quot;sharpen&quot; the resulting probabilities.
      </p>
<pre><code class="language-julia">function sample(model, n, temp = 1)
  s = [rand(alphabet)]
  m = unroll1(model)
  for i = 1:n-1
    push!(s, wsample(alphabet, softmax(m(unsqueeze(onehot(s[end], alphabet)))./temp)[1,:]))
  end
  return string(s...)
end

sample(model[1:end-1], 100)</code></pre>
      <p>
<code>sample</code>
 then produces a string of Shakespeare-like text. This won&#39;t produce great results after only a single epoch (though they will be recognisably different from the untrained model). Going for 30 epochs or so produces good results.
      </p>
      <p>
Trained on 
        <a href="https://gist.githubusercontent.com/MikeInnes/c2d11b57a58d7f2466b8013b88df1f1c/raw/4423f7cb07c71c80bd6458bb94f7bf5338403284/julia.jl">
a dataset from base Julia
        </a>
, the network can produce code like:
      </p>
<pre><code class="language-julia">function show(io::IO, md::Githompty)
    Buffer(jowerTriangular(inals[i], initabs_indices), characters, side, nextfloat(typeof(x)))
    isnull(r) &amp;&amp; return
    start::I!
    for j = 1:length(b,1)
        a = s-&gt;cosvect(code)
        return
    end
    indsERenv | maximum(func,lsg))
    for i = 1:last(Abjelar) &amp;&amp; fname (=== nothing)
        throw(ArgumentError(&quot;read is declave non-fast-a/remaining of not descride method names&quot;))
    end
    if e.ht === Int
        # update file to a stroducative, but is decould.
        # xna i -GB =# [unsafe_color &lt;c *has may num 20&lt;11E 16/s
        tuple | Expr(:(UnitLowerTriangular(transpose,(repl.ptr)))
        dims = pipe_read(s,Int(a)...)
    ex,0 + y.uilid_func &amp; find_finwprevend(msg,:2)
    ex = stage(c)
    # uvvalue begin
    end
end</code></pre>
      <footer>
        <hr/>
        <a class="previous" href="logreg.html">
          <span class="direction">
Previous
          </span>
          <span class="title">
Simple MNIST
          </span>
        </a>
        <a class="next" href="../contributing.html">
          <span class="direction">
Next
          </span>
          <span class="title">
Contributing &amp; Help
          </span>
        </a>
      </footer>
    </article>
  </body>
</html>
